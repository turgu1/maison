<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Maison Library: Maison - Minimally Secure ESP8266 IOT MQTT based Framework</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Maison Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="classMaison.html">Maison</a> - Minimally Secure ESP8266 IOT MQTT based Framework </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Note: This is still work in progress. The documentation is also a work in progress. The code is working and must be considered of a Beta level.</p>
<p>This library implements a small, minimally secure, IOT Framework for embedded ESP8266 devices to serve into a Home IOT environment. It diminishes the amount of code to be put in the targeted application source code. The application interacts with the framework through a Finite State Machine algorithm allowing for specific usage at every stage.</p>
<p>Here are the main characteristics:</p>
<ul>
<li>Framework configuration saved in file through SPIFFS.</li>
<li>WiFi MQTT based communications. Nothing else.</li>
<li>TLS encryption: All MQTT communication with encryption.</li>
<li>Server authentication through fingerprinting.</li>
<li>User/Password identification.</li>
<li>JSON based data transmission with server.</li>
<li>Configuration updates through MQTT.</li>
<li>Option: Automated Watchdog transmission every 24 hours.</li>
<li>Option: Battery voltage transmission.</li>
<li>Option: DeepSleep or continuous power.</li>
<li>Option: Application specific MQTT topic subscription.</li>
<li>Option: Application specific automatic state saving in RTC memory.</li>
<li>Option: Verbose/Silent debugging output through compilation.</li>
</ul>
<p>The MQTT based transmission architecture is specific to this implementation and is describe below.</p>
<p>The framework is to be used with the <a href="https://platformio.org/">PlarformIO</a> ecosystem. Some (soon to be supplied) examples are to be compiled through PlatformIO.</p>
<p>Note that the library maybe usable through the Arduino IDE, but this is not supported. It is known to be a challenge to set compiling options and access <a class="el" href="classMaison.html">Maison</a> defined types from .ino source code.</p>
<p>The <a class="el" href="classMaison.html">Maison</a> framework, to be functional, requires the following:</p>
<ul>
<li>Proper application setup parameters in file <code>platformio.ini</code>. Look at the <a href="#2-building-an-application">Building an Application</a> section;</li>
<li>Code in the user application to setup and use the framework. Look at the <a href="#code-usage">Code Usage</a> section;</li>
<li>Configuration parameters located in SPIFFS (file <code>/config.json</code>). Look at the <a href="#configuration-parameters">Configuration Parameters</a> section.</li>
</ul>
<p>The sections below describe the specific of these requirements.</p>
<h2>1. Overview</h2>
<p>The <a class="el" href="classMaison.html">Maison</a> library supplies the usual algorithms required for an IOT device to interact within an event management architecture based on the use of a MQTT broker for message exchanges. It helps the programmer in the management of the various aspects of integrating the code responsible of the functionality of the IOT device with the intricacies of managing the lifespan inside the architecture.</p>
<p>(To be completed)</p>
<p>The following sequence diagram shows the automated interaction between the device and the MQTT broker.</p>
<div class="image">
<img src="./doc/sequence_uml.png" />
</div>
<h2>2. Building an Application</h2>
<p>The <a class="el" href="classMaison.html">Maison</a> framework is using the following libraries and, through its library configuration, automate their retrieval through the PlatformIO ecosystem:</p>
<ul>
<li>PubSubClient</li>
<li>BearSSL</li>
<li>ArduinoJSON</li>
</ul>
<p>The following options <b>shall</b> be added to the <code>plarformio.ini</code> file of your application to integrate the framework:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;lib_deps = https://github.com/turgu1/maison.git</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;build_flags = -D MQTT_MAX_PACKET_SIZE=512</div></div><!-- fragment --><p>Note that <em>MQTT_MAX_PACKET_SIZE</em> can be larger depending of the application requirements.</p>
<p>The following options in <code>platformio.ini</code> <b>shall</b> also be used:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;framework = arduino</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;platform = espressif8266</div></div><!-- fragment --> <h3>2.1 Compilation Options</h3>
<p>The <a class="el" href="classMaison.html">Maison</a> framework allow for some defined options to be modified through -D compilation parameters (PlatformIO: build_flags). The following are the compilation options available to change some library behavior:</p>
<table class="doxtable">
<tr>
<th align="center">Option </th><th align="center">Default </th><th>Description  </th></tr>
<tr>
<td align="center">MAISON_TESTING </td><td align="center">0 </td><td>If = 1, enable debuging output through the standard Serial port. The serial port must be initialized by the application (Serial.begin()) before calling any <a class="el" href="classMaison.html">Maison</a> function. </td></tr>
<tr>
<td align="center">QUICK_TURN </td><td align="center">0 </td><td>If = 1, HOURS_24 state is fired every 2 minutes instead of 24 hours. This is automatically the case when <em>MAISON_TESTING</em> is set to 1, unless QUICK_TURN is also defined in build_flags. </td></tr>
<tr>
<td align="center">MAISON_PREFIX_TOPIC </td><td align="center">maison/ </td><td>All topics used by the framework are prefixed with this text </td></tr>
<tr>
<td align="center">MAISON_STATUS_TOPIC </td><td align="center">maison/status </td><td>Topic where the framework status are sent </td></tr>
<tr>
<td align="center">MAISON_CTRL_TOPIC </td><td align="center">maison/ctrl </td><td>Topic where the framework event controls are sent </td></tr>
<tr>
<td align="center">CTRL_SUFFIX_TOPIC </td><td align="center">ctrl </td><td>This is the topic suffix used to identify device-related control topic </td></tr>
<tr>
<td align="center">DEFAULT_SHORT_REBOOT_TIME </td><td align="center">5 </td><td>This is the default reboot time in seconds when deep sleep is enable. This is used at the end of the following states: <em>PROCESS_EVENT</em>, <em>WAIT_END_EVENT</em>, <em>END_EVENT</em>. For the other states, the wait time is 60 minutes (3600 seconds). </td></tr>
</table>
<p>Note that for <em>MAISON_STATUS_TOPIC</em> and <em>MAISON_CTRL_TOPIC</em>, they will be modified automatically if <em>MAISON_PREFIX_TOPIC</em> is changed. For example, if you change <em>MAISON_PREFIX_TOPIC</em> to be <code>home/</code>, <em>MAISON_STATUS_TOPIC</em> will become <code>home/status</code> and <em>MAISON_CTRL_TOPIC</em> will become <code>maison/ctrl</code>.</p>
<p>The framework will subscribe to MQTT messages coming from the server on a topic built using <em>MAISON_PREFIX_TOPIC</em>, the device name and <em>CTRL_SUFFIX_TOPIC</em>. For example, if the device name is "WATER_SPILL", the subscribed topic would be <code>maison/WATER_SPILL/ctrl</code>.</p>
<h2>3. Usage</h2>
<p>The <a class="el" href="classMaison.html">Maison</a> framework is expecting the following aspects to be properly in place for its usage on a device:</p>
<ol type="1">
<li><a href="#application-source-code">Application Source Code</a> with the <a class="el" href="classMaison.html">Maison</a> framework integration.</li>
<li>A <a href="#configuration-parameters">Configuration Parameters</a> file.</li>
<li>A <a href="#mqtt-broker">MQTT broker</a> on a networked server.</li>
</ol>
<p>The following sections explain each of this elements.</p>
<h2>4. Application Source Code</h2>
<p>Here is a minimal piece of code to initialize and start the framework:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{C++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;#include &lt;Maison.h&gt;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;Maison maison();</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;void setup()</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;{</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  maison.setup();</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;}</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;void loop()</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;{</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;  maison.loop();</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;}</div></div><!-- fragment --><p>This piece of code won't do much at the user application level, but it will set the scene to the automation of exchanges with a MQTT message broker, sending startup/watchdog messages, answering information requests, changes of configuration, completely automated through <a class="el" href="classMaison.html">Maison</a> framework.</p>
<p>Here is a more complete example of code to be used to initialize the framework with optional features and integrate it in the loop() function. It shows both option parameters, calls to the framework with message callback and finite state machine functions:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{C++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;ADC_MODE(ADC_VCC);</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;#include &lt;Maison.h&gt;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;struct user_data {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  uint32_t crc;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  int my_data;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;  ...</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;} my_state;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;Maison maison(Maison::Feature::WATCHDOG_24H|</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;              Maison::Feature::VOLTAGE_CHECK,</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;              &amp;my_state, sizeof(my_state));</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;void msg_callback(const char  * topic,</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;                  byte        * payload,</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;                  unsigned int  length)</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;{</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;}</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;Maison::UserResult process_state(Maison::State state)</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;{</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;  switch (state) {</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    case ...</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  }</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  return Maison::UserResult::COMPLETED;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;}</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;void setup()</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;{</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;  maison.setup();</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  maison.set_msg_callback(&quot;my_topic&quot;, msg_callback, 0);</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;}</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;void loop()</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  maison.loop(process_state);</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;}</div></div><!-- fragment --><p>The use of <code>process_state</code> and <code>set_msg_callback</code> is optional.</p>
<p>In the following sections, we describe the specific aspects of this code example.</p>
<h3>4.1 Include File</h3>
<p>The <code>#include &lt;<a class="el" href="Maison_8h_source.html">Maison.h</a>&gt;</code> integrates the <a class="el" href="classMaison.html">Maison</a> header into the user application. This will import the <a class="el" href="classMaison.html">Maison</a> class declaration and a bunch of definitions that are documented below. All required libraries needed by the framework are also included by this call.</p>
<h3>4.2 <a class="el" href="classMaison.html">Maison</a> Declaration</h3>
<p>The <code><a class="el" href="classMaison.html">Maison</a> maison(...)</code> declaration create an instance of the framework. This declaration accepts the following parameters:</p>
<ul>
<li>An optional <a href="#feature-mask">feature mask</a>, to enable some aspects of the framework (see table below).</li>
<li>An optional <a href="#user-application-state-structure">user application state structure</a> (here named <code>my_state</code>) and it's size to be automatically saved in non-volatile memory when DeepSleep is enabled.</li>
</ul>
<h4>4.2.1 Feature Mask</h4>
<p>The following table show the current features supported through the feature mask (They are part of the <a class="el" href="classMaison.html#a78d9ef41e0b19f1018697766cf7d47d7">Maison::Feature</a> enum definition):</p>
<table class="doxtable">
<tr>
<th align="center">Feature Name </th><th>Description  </th></tr>
<tr>
<td align="center">NONE </td><td>No feature selected. </td></tr>
<tr>
<td align="center">VOLTAGE_CHECK </td><td>Chip A2D voltage readout will be sent on status/watchdog messages. </td></tr>
<tr>
<td align="center">DEEP_SLEEP </td><td>deep_sleep will be used by the framework to limit power usage (e.g. on batteries). RESET/RST and WAKE/GPIO16 pins need to be wired together. </td></tr>
<tr>
<td align="center">WATCHDOG_24H </td><td>A Watchdog message will be sent every 24 hours. </td></tr>
</table>
<p>To use them, you have to prefix them with <code><a class="el" href="classMaison.html">Maison</a>::</code> or <code><a class="el" href="classMaison.html#a78d9ef41e0b19f1018697766cf7d47d7">Maison::Feature</a>::</code> as shown in the code example.</p>
<p>Note: if the <em>VOLTAGE_CHECK</em> feature is selected, the following line is required to be put at the beginning of the main application sketch:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{C++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;ADC_MODE(ADC_VCC);</div></div><!-- fragment --><h4>4.2.2 User Application State Structure</h4>
<p>The user application state structure (here named <code>user_data</code>) <b>shall</b> have a <code>uint32_t</code> item as the first element in the structure. This is used by the framework to verify that the content saved in non-volatile memory is valid using a CRC-32 checksum. The whole content will be initialized (zeroed) if the checksum is bad. The checksum is computed by the framework, the user application just need to supplied the space in the structure.</p>
<p>This structure is optional and could be required by the application when the <em>DEEP_SLEEP</em> feature is selected. It will allow for the saving and retrieval of the current application state as the Deep Sleep feature induce processor resets that invalidate the memory content.</p>
<h3>4.3 maison.loop()</h3>
<p>The <a class="el" href="classMaison.html#a975d3487e9cc05a3f17ca2b22d8343eb">Maison::loop()</a> function must be called regularly in the user application main loop function to permit the execution of the finite state machine and the receiving of new MQTT messages. As a parameter, the <a class="el" href="classMaison.html#a975d3487e9cc05a3f17ca2b22d8343eb">Maison::loop()</a> function accepts a processing function that will be called by <a class="el" href="classMaison.html">Maison</a> inside the finite state machine. The function will receive the current state value as a parameter. It must return a status value from the following list:</p>
<table class="doxtable">
<tr>
<th align="center">Value </th><th>Description  </th></tr>
<tr>
<td align="center">COMPLETED </td><td>Returned when the processing for the current state is considered completed. This is used mainly for all states. </td></tr>
<tr>
<td align="center">NOT_COMPLETED </td><td>The reverse of <em>COMPLETED</em>. Mainly used with <em>PROCESS_EVENT</em> in the case that it must be fired again to complete the processing </td></tr>
<tr>
<td align="center">ABORTED </td><td>Return in the case of <em>PROCESS_EVENT</em> when the event vanished before processing, such that the finite state machine return to the <em>WAIT_FOR_EVENT</em> state instead of going to the <em>WAIT_END_EVENT</em> state. </td></tr>
<tr>
<td align="center">NEW_EVENT </td><td>Returned when processing a <em>WAIT_FOR_EVENT</em> state to indicate that an event must be processed. </td></tr>
<tr>
<td align="center">RETRY </td><td>When in state <em>WAIT_END_EVENT</em>, will return back to <em>PROCESS_EVENT</em> to check again for event processing </td></tr>
</table>
<p>Note: if the <em>DEEP_SLEEP</em> feature was enabled, the loop will almost never return as the processor will wait for further processing through a call to ESP.deep_sleep function. The processor, after the wait time, will restart the code execution from the beginning.</p>
<h2>5. Configuration Parameters</h2>
<p>The <a class="el" href="classMaison.html">Maison</a> framework is automating access to the MQTT message broker through the WiFi connection. As such, parameters are required to link the device to the WiFi network and the MQTT broker server. A file named "/config.json" must be created on a SPIFFS file system in flash memory. This is a JSON structured file. Here is an example of such a file:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &quot;version&quot; : 1,</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  &quot;device_name&quot; : &quot;WATER_SPILL&quot;,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  &quot;ssid&quot; : &quot;the wifi ssid&quot;,</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  &quot;wifi_password&quot; : &quot;the wifi password&quot;,</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  &quot;mqtt_server_name&quot; : &quot;the server name or IP address&quot;,</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  &quot;mqtt_user_name&quot; : &quot;the user name&quot;,</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  &quot;mqtt_password&quot; : &quot;password&quot;,</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;  &quot;mqtt_port&quot; : 8883,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;  &quot;mqtt_fingerprint&quot; : [13,217,75,226,184,245,80,117,113,43,18,251,39,75,237,77,35,65,10,19]</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;}</div></div><!-- fragment --><p>All parameters must be present in the file to be considered valid by the framework. Here is a description of each parameter:</p>
<table class="doxtable">
<tr>
<th align="center">Parameter </th><th>Description  </th></tr>
<tr>
<td align="center">version </td><td>This is the sequential version number. This is the property of the Server responsible of transmitting new configuration files to the device. It must be incremented every time a new configuration file is sent to the device. The device will not update its configuration if the version number is not greater than the current one. Unsigned Integer value (16 bits). </td></tr>
<tr>
<td align="center">device_name </td><td>A unique identifier for the device. This identifier is used inside messages sent through MQTT. It is also used to generate the topics related to the device. It can be an empty string: the MAC address of the device WiFi interface will then be used as the identifier. Use letters, underscore, numbers to compose the identifier (no space or other special characters). Max length: 15 ASCII characters. </td></tr>
<tr>
<td align="center">ssid / wifi_password </td><td>The WiFi SSID and password. Required to reach the network. Max length: 15 ASCII characters each. </td></tr>
<tr>
<td align="center">mqtt_server_name </td><td>This is the MQTT server name (SQDN) or IP address. Max length: 31 ASCII characters. </td></tr>
<tr>
<td align="center">mqtt_user_name / mqtt_password </td><td>These are the credentials to connect to the MQTT server. Max length: 15 ASCII characters for user_name, 31 ASCII characters for password. </td></tr>
<tr>
<td align="center">mqtt_port </td><td>The TLS/SSL port number of the MQTT server. Unsigned Integer value (16 bits). </td></tr>
<tr>
<td align="center">mqtt_fingerprint </td><td>This is the fingerprint associated with the MQTT service certificate. It must be a vector of 20 decimal values. Each value correspond to a byte part of the fingerprint. This is used to validate the MQTT server by the BearSSL library. Length: 20 bytes. </td></tr>
</table>
<h3>5.1 PlatformIO configuration</h3>
<p>A SPIFFS flash file system must be put in place on the targeted device. This can be accomplished through the following process, as described in the <a href="https://docs.platformio.org/en/latest/platforms/espressif8266.html#uploading-files-to-file-system-spiffs">platformio documentation</a>:</p>
<ol type="1">
<li>Put the <b>config.json</b> in a folder named <code>data</code> located at the same level as for the application <code>src</code> folder.</li>
<li>Add the following compilation options to the <code>build_flags</code> element of the <b>platformio.ini</b> file:</li>
</ol>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;-Wl,-Teagle.flash.4m1m.ld</div></div><!-- fragment --><ol type="1">
<li>Connect the device to the computer</li>
<li>Kill the PlatformIO Serial Monitor. The next step won't work if the Serial Monitor is working.</li>
<li>Initiate the flash memory preparation of the SPIFFS file system using the PlatformIO "Upload File System image" task from the IDE.</li>
</ol>
<h2>6. MQTT Broker</h2>
<p>(To be completed)</p>
<h2>7. Messages sent by the framework</h2>
<p>The <a class="el" href="classMaison.html">Maison</a> framework automate some messages that are sent to the <b>maison/status</b> topic. All messages are sent using a JSON formatted string.</p>
<p>Here is a description of each message sent, namely:</p>
<ul>
<li>The Startup message</li>
<li>The Status message</li>
<li>The Watchdog message</li>
<li>The Config message</li>
</ul>
<h3>7.1 The Startup message</h3>
<p>This message is sent to the MQTT topic <b>maison/status</b> when the device is reset (Usually because of a Power-On action or a reset button being pressed). It is not sent when a DeepSleep wake-up action is taken by the device.</p>
<table class="doxtable">
<tr>
<th align="center">Parameter </th><th>Description  </th></tr>
<tr>
<td align="center">device </td><td>The device name as stated in the configuration parameters. If the configuration parameter is empty, the MAC address of the device WiFi interface is used. </td></tr>
<tr>
<td align="center">msg_type </td><td>This content the string "STARTUP". </td></tr>
<tr>
<td align="center">reason </td><td>The reason for startup (hardware reset type). </td></tr>
<tr>
<td align="center">VBAT </td><td>This is the Battery voltage. This parameter is optional. Its presence depend on the <em>VOLTAGE_CHECK</em> feature. See the description of the <a href="#feature-mask">Feature Mask</a>. </td></tr>
</table>
<p>The hardware reset reason come from the ESP8266 reset information:</p>
<table class="doxtable">
<tr>
<th align="center">value </th><th>description  </th></tr>
<tr>
<td align="center">0 </td><td>Power Reboot </td></tr>
<tr>
<td align="center">1 </td><td>Hardware WDT Reset </td></tr>
<tr>
<td align="center">2 </td><td>Fatal Exception </td></tr>
<tr>
<td align="center">3 </td><td>Software Watchdog Reset </td></tr>
<tr>
<td align="center">4 </td><td>Software Reset </td></tr>
<tr>
<td align="center">5 </td><td>Deep Sleep Reset </td></tr>
<tr>
<td align="center">6 </td><td>Hardware Reset </td></tr>
</table>
<p>Example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{&quot;device&quot;:&quot;WATER_SPILL&quot;,&quot;msg_type&quot;:&quot;STARTUP&quot;,&quot;reason&quot;:6,&quot;VBAT&quot;:3.0}</div></div><!-- fragment --><h3>7.2 The Status message</h3>
<p>This message is sent to the MQTT topic <b>maison/status</b> when a message sent to the device control topic (e.g. <b>maison/device_name/ctrl</b>) containing the string "STATE?" is received.</p>
<table class="doxtable">
<tr>
<th align="center">Parameter </th><th>Description  </th></tr>
<tr>
<td align="center">device </td><td>The device name as stated in the configuration parameters. If the configuration parameter is empty, the MAC address of the device WiFi interface is used. </td></tr>
<tr>
<td align="center">msg_type </td><td>This content the string "STATE". </td></tr>
<tr>
<td align="center">state </td><td>The current state of the finite state machine, as a number. Look into the <a href="#the-finite-state-machine">Finite State Machine</a> section for details. </td></tr>
<tr>
<td align="center">return_state </td><td>The state to return to after <em>HOURS_24</em> processing. </td></tr>
<tr>
<td align="center">hours </td><td>Hours counter. Used to compute the next 24 hours period. </td></tr>
<tr>
<td align="center">millis </td><td>Milliseconds in the last hour. </td></tr>
<tr>
<td align="center">lost </td><td>Counter of the number of time the connection to the MQTT broker has been lost. </td></tr>
<tr>
<td align="center">rssi </td><td>The WiFi signal strength of the connection to the router, a relative signal quality measurement. -50 means a pretty good signal, -75 fearly reasonnable and -100 means no signal. </td></tr>
<tr>
<td align="center">heap </td><td>The current value of the free heap space available on the device </td></tr>
<tr>
<td align="center">VBAT </td><td>This is the Battery voltage. This parameter is optional. Its presence depends on the <em>VOLTAGE_CHECK</em> feature. See the description of the <a href="#feature-mask">Feature Mask</a>. </td></tr>
</table>
<p>Example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{&quot;device&quot;:&quot;WATER_SPILL&quot;,&quot;msg_type&quot;:&quot;STATE&quot;,&quot;state&quot;:32,&quot;return_state&quot;:2,hours&quot;:7,&quot;millis&quot;:8001,&quot;lost&quot;:0,&quot;rssi&quot;:-63,&quot;heap&quot;:16704,&quot;VBAT&quot;:3.0}</div></div><!-- fragment --><h3>7.3 The Watchdog Message</h3>
<p>This message is sent to the MQTT topic <b>maison/status</b> every 24 hours. Its transmission is enabled through the <em>WATCHDOG_24H</em> feature. See the description of the <a href="#feature-mask">Feature Mask</a>.</p>
<table class="doxtable">
<tr>
<th align="center">Parameter </th><th>Description  </th></tr>
<tr>
<td align="center">device </td><td>The device name as stated in the configuration parameters. If the configuration parameter is empty, the MAC address of the device WiFi interface is used. </td></tr>
<tr>
<td align="center">msg_type </td><td>This content the string "WATCHDOG". </td></tr>
<tr>
<td align="center">VBAT </td><td>This is the Battery voltage. This parameter is optional. Its presence depend on the <em>VOLTAGE_CHECK</em> feature. See the description of the <a href="#feature-mask">Feature Mask</a>. </td></tr>
</table>
<p>Example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{&quot;device&quot;:&quot;WATER_SPILL&quot;,&quot;msg_type&quot;:&quot;WATCHDOG&quot;,&quot;VBAT&quot;:3.0}</div></div><!-- fragment --><h3>7.4 The Config message</h3>
<p>This message is sent to the MQTT topic <b>maison/status</b> when a message sent to the device control topic (e.g. <b>maison/device_name/ctrl</b>) containing the string "CONFIG?" is received.</p>
<table class="doxtable">
<tr>
<th align="center">Parameter </th><th>Description  </th></tr>
<tr>
<td align="center">device </td><td>The device name as stated in the configuration parameters. If the configuration parameter is empty, the MAC address of the device WiFi interface is used. </td></tr>
<tr>
<td align="center">msg_type </td><td>This content the string "CONFIG". </td></tr>
<tr>
<td align="center">content </td><td>This is the configuration of the device in a JSON format. See the <a href="#configuration-parameters">Configuration Parameters</a> section for the format details. </td></tr>
</table>
<p>Example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{&quot;device&quot;:&quot;WATER_SPILL&quot;,&quot;msg_type&quot;:&quot;CONFIG&quot;,&quot;content&quot;:{</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;  &quot;version&quot;          : 1,</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  &quot;device_name&quot;      : &quot;TEST_DEV&quot;,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  &quot;ssid&quot;             : &quot;the_ssid&quot;,</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;  &quot;wifi_password&quot;    : &quot;the_password&quot;,</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  &quot;mqtt_server_name&quot; : &quot;the_server_sqdn&quot;,</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  &quot;mqtt_user_name&quot;   : &quot;the_mqtt_user_name&quot;,</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  &quot;mqtt_password&quot;    : &quot;the_mqtt_password&quot;,</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;  &quot;mqtt_port&quot;        : 8883,</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;  &quot;mqtt_fingerprint&quot; : [13,217,75,226,184,245,80,117,113,43,18,251,39,75,237,77,35,65,10,19]</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;}}</div></div><!-- fragment --><h2>8. The Finite State Machine</h2>
<p>The finite state machine is processed inside the <code><a class="el" href="classMaison.html#a975d3487e9cc05a3f17ca2b22d8343eb">Maison::loop()</a></code> function.</p>
<p>When using the <em>DEEP_SLEEP</em> <a href="#feature-mask">feature</a>, networking is disabled for some of the states to minimize battery usage. If the <em>DEEP_SLEEP</em> feature is not used, networking is available all the time. The <code><a class="el" href="classMaison.html#a737fc95f3204808f969b025eb3a76d5c">Maison::network_is_available()</a></code> function can be used to check network availability.</p>
<table class="doxtable">
<tr>
<th align="center">State </th><th align="center">Value </th><th align="center">Network </th><th>Description  </th></tr>
<tr>
<td align="center">STARTUP </td><td align="center">1 </td><td align="center">YES </td><td>The device has just been reset. </td></tr>
<tr>
<td align="center">WAIT_FOR_EVENT </td><td align="center">2 </td><td align="center">NO </td><td>This is the state waiting for an event to occur. The event is application specific. </td></tr>
<tr>
<td align="center">PROCESS_EVENT </td><td align="center">4 </td><td align="center">YES </td><td>An event is being processed by the application. This will usually send a message to the MQTT broker. </td></tr>
<tr>
<td align="center">WAIT_END_EVENT </td><td align="center">8 </td><td align="center">NO </td><td>The device is waiting for the end of the event to occur. </td></tr>
<tr>
<td align="center">END_EVENT </td><td align="center">16 </td><td align="center">YES </td><td>The end of an event has been detected. It's time to do an event rundown. This will usually send a message to the MQTT broker. </td></tr>
<tr>
<td align="center">HOURS_24 </td><td align="center">32 </td><td align="center">YES </td><td>This event occurs every 24 hours. It permits the transmission of a Watchdog message if enabled with the <em>WATCHDOG_24H</em> feature. The state is required to have at least one state per day for which the network interface is energized to allow for the reception of configuration and control messages. </td></tr>
</table>
<p>Here is a state diagram showing the inter-relationship between each state and the corresponding application process return values for witch state changes will be fired:</p>
<div class="image">
<img src="./doc/state_uml.png" />
</div>
<h2>9. Usage on battery power</h2>
<p>The <a class="el" href="classMaison.html">Maison</a> framework can be tailored to use Deep Sleep when on battery power, through the <em>DEEP_SLEEP</em> <a href="#feature-mask">feature</a>.</p>
<p>In this context, the finite state machine will cause a call to the <code>ESP.deep_sleep()</code> function at the end of each of its processing cycle (function <code><a class="el" href="classMaison.html#a975d3487e9cc05a3f17ca2b22d8343eb">Maison::loop()</a></code>) to put the processor in a dormant state. The deep sleep duration, by default, is set to 5 seconds before entry to the states <em>PROCESS_EVENT</em>, <em>WAIT_END_EVENT</em>, <em>END_EVENT</em> and <em>HOURS_24</em>; it is 3600 seconds for <em>WAIT_FOR_EVENT</em>.</p>
<p>If the deep sleep feature is enabled, the call to <code><a class="el" href="classMaison.html#a975d3487e9cc05a3f17ca2b22d8343eb">Maison::loop()</a></code> never return to the caller as the processor will reset after the deep sleep period.</p>
<p>It is expected that a hardware interrupt will wake up the device to indicate the arrival of a new event. If it's not the case, it will be then be required to modulate the amount of time to wait for the next <em>WAIT_FOR_EVENT</em> state to occurs. This must be used with caution as it will have an impact on the battery capacity.</p>
<p>The application process can change the amount of seconds for the next deep sleep period using the <code><a class="el" href="classMaison.html#a20db75bbcbdca7c2b07316c5115db0aa">Maison::set_deep_sleep_wait_time()</a></code> function. This can be called inside the application <code>process_state()</code> function before returning control to the framework.</p>
<p>The ESP8266 does not allow for a sleep period longer than 4294967295 microseconds, that corresponds to around 4294 seconds or 71 minutes.</p>
<p>If <em>DEEP_SLEEP</em> is not used, there is no wait time other than the code processing time in the <code><a class="el" href="classMaison.html#a975d3487e9cc05a3f17ca2b22d8343eb">Maison::loop()</a></code>. Internally, the framework compute the duration of execution for the next <em>HOURS_24</em> state to occur. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
